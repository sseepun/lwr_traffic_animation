<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <style>
      .button1 rect {
        rx:4px; ry:4px; fill:white; stroke:black; stroke-width:0.25;
        background:-webkit-linear-gradient(white, grey);
      }
    </style>
    <script src="https://d3js.org/d3.v3.js"></script>
</head>
<body>
  <div id="buttons" style="align:middle; padding-top:20px; background-color:#e9f6fb; margin-left:14px; margin-right:20px;">
      <button onclick="carMove();" style="width:100px; height:40px; margin-left:200px;">Simulation</button>
      <button onclick="stopProcess();" style="width:100px; height:40px; margin-left:10px;">Stop</button>
      <button onclick="carBreak();" style="width:100px; height:40px; margin-left:10px;">Car break</button>

      <button onclick="showSpeedFunc();" style="width:100px; height:40px; margin-left:150px;">Show speed</button>

      <input type="number" id="carNum" min="1" max="50" value=22 style="width:50px; height:34px; margin-left:150px; align:middle;">
      <button onclick="reset();" style="width:100px; height:40px; margin-left:10px;">Reset</button>
  </div>
</body>

<script>
function showSpeedFunc(){showSpeed*=-1,carWorkspace.selectAll("rect.speed-bar").attr("opacity",function(){return 1==showSpeed?.9:0})}function reset(){stop=!0,slow=-1,carNumber=d3.select("body").select("input#carNum").property("valueAsNumber"),console.log(carNumber),carArray=d3.range(1,carNumber+1),x=d3.scale.linear().range([0,width]).domain([0,carNumber]),color=d3.scale.linear().range(["red","orange","yellowGreen"]).domain([0,.4*maxSpeed,.7*maxSpeed]),carSelected="g#car-"+Math.round(carNumber/2),slow=-1,carSpace=carWorkspace.selectAll("g.car").data(carArray),carSpace.exit().remove();var a=carSpace.enter().append("g").attr("class","car").attr("id",function(a){return"car-"+a}).attr("follow",function(a){return a!=carNumber?"car-"+(a+1):"car-1"}).attr("speed",initSpeed).attr("acc",0).attr("nowX",function(a){return x(a)}).attr("transform",function(a){return"translate("+x(a)+", 0)"});a.append("rect").attr("class","selection").attr("transform","translate("+-cW+","+(height-rH+4)+")").attr("width",cW).attr("height",rH-8).attr("fill",function(a){return a==Math.round(carNumber/2)?selectedColor:"rgb(41, 48, 56)"}).on("click",function(a){carSelected="g#car-"+a,carWorkspace.selectAll("g").select("rect.selection").attr("fill","rgb(41, 48, 56)"),carWorkspace.select(carSelected).select("rect.selection").attr("fill",selectedColor)}),h=d3.scale.linear().range([0,maxH]).domain([0,maxSpeed]),a.append("rect").attr("class","speed-bar").attr("transform","translate("+-cW+","+(maxH-h(initSpeed))+")").attr("height",h(initSpeed)).attr("width",cW).attr("fill",color(initSpeed)).attr("opacity",function(){return 1==showSpeed?.9:0});var b=a.append("g").attr("class","car-sticker").attr("transform","translate(0,"+.82*height+")scale(-0.25, 0.4)").attr("fill",color(initSpeed));b.append("path").attr("d","M 60.305562,10.535 48.492694,8.8979996 45.757389,-3.8766301e-7 l -20.857001,0 L 20.391999,9.8189996 1.4916526,11.456 0,24.445 l 4.3187416,0 c 0.29602,-4.882 2.799736,-8.694 5.8456504,-8.694 3.045305,0 5.549021,3.812 5.845041,8.694 l 26.91722,0 c 0.296021,-4.882 2.799736,-8.694 5.845042,-8.694 3.031933,0 5.527138,3.778 5.841394,8.628 l 5.318648,-1.264 c 0.0012,0.001 1.636928,-10.099 0.373825,-12.58 z m -26.407238,0.23 -10.496086,0 4.085937,-8.8980004 6.410149,0 z m 3.134848,0 0,-8.8990004 5.894696,0 2.735913,8.8980004 c 0,0 -5.471362,0.190393 -8.630609,0 -3.33e-4,-2e-5 0,0.001 0,0.001 z").on("click",function(a){carSelected="g#car-"+a,carWorkspace.selectAll("g").select("rect.selection").attr("fill","rgb(41, 48, 56)"),carWorkspace.select(carSelected).select("rect.selection").attr("fill",selectedColor)}),b.append("path").attr("d","m 10.054902,17.506593 c -2.5569618,0 -4.6249999,2.068038 -4.6249999,4.625 0,2.556962 2.0680381,4.65625 4.6249999,4.65625 2.556962,0 4.625,-2.099288 4.625,-4.65625 0,-2.556962 -2.068038,-4.625 -4.625,-4.625 z m 0,2.90625 c 0.961699,0 1.75,0.757051 1.75,1.71875 0,0.961699 -0.788301,1.75 -1.75,1.75 -0.9616987,0 -1.7499999,-0.788301 -1.7499999,-1.75 0,-0.961699 0.7883012,-1.71875 1.7499999,-1.71875 z").on("click",function(a){carSelected="g#car-"+a,carWorkspace.selectAll("g").select("rect.selection").attr("fill","rgb(41, 48, 56)"),carWorkspace.select(carSelected).select("rect.selection").attr("fill",selectedColor)}),b.append("path").attr("d","m 48.702755,17.506593 c -2.556962,0 -4.625,2.068038 -4.625,4.625 0,2.556962 2.068038,4.65625 4.625,4.65625 2.556962,0 4.625,-2.099288 4.625,-4.65625 0,-2.556962 -2.068038,-4.625 -4.625,-4.625 z m 0,2.90625 c 0.961699,0 1.75,0.757051 1.75,1.71875 0,0.961699 -0.788301,1.75 -1.75,1.75 -0.961699,0 -1.75,-0.788301 -1.75,-1.75 0,-0.961699 0.788301,-1.71875 1.75,-1.71875 z").on("click",function(a){carSelected="g#car-"+a,carWorkspace.selectAll("g").select("rect.selection").attr("fill","rgb(41, 48, 56)"),carWorkspace.select(carSelected).select("rect.selection").attr("fill",selectedColor)}),carSpace.transition().duration(1200).attr("speed",initSpeed).attr("acc",0).attr("nowX",function(a){return x(a)}).attr("follow",function(a){return a!=carNumber?"car-"+(a+1):"car-1"}).attr("transform",function(a){return"translate("+x(a)+", 0)"}),carSpace.select("rect.selection").attr("fill",function(a){return a==Math.round(carNumber/2)?selectedColor:"rgb(41, 48, 56)"}).on("click",function(a){carSelected="g#car-"+a,carWorkspace.selectAll("g").select("rect.selection").attr("fill","rgb(41, 48, 56)"),carWorkspace.select(carSelected).select("rect.selection").attr("fill",selectedColor)}),carSpace.select("rect.speed-bar").attr("transform","translate("+-cW+","+(maxH-h(initSpeed))+")").attr("height",h(initSpeed)).attr("fill",color(initSpeed)).attr("opacity",function(){return 1==showSpeed?.9:0}),carSpace.select("g.car-sticker").attr("transform","translate(0,"+.82*height+")scale(-0.25, 0.4)").attr("fill",color(initSpeed)),carWorkspace=svg.select("g.car-workspace")}function stopProcess(){stop=!0}function carBreak(){slow*=-1}function carMove(){stop=!1,d3.select("body").select("button#move").attr("fill","black"),carWorkspace.selectAll("g.car").each(slide)}function slide(){if(1==slow&&(carWorkspace.select(carSelected).attr("speed",0),carWorkspace.select(carSelected).attr("acc",0)),!stop){var a=d3.select(this),b="g#"+a.attr("follow"),c=carWorkspace.select(b),d=Math.abs(Number(c.attr("nowX"))-Number(a.attr("nowX")));d>width/2&&(d=width-Number(a.attr("nowX"))+Number(c.attr("nowX")));var g,e=Number(a.attr("acc")),f=Number(a.attr("speed"));d<=1.2*cW?(g=0,f=0):g=Math.abs(f-d)<cW?0:f>d?d3.min([-40*accChange,e-accChange]):d3.max([80*accChange,e+accChange]),a.attr("acc",g),a.select("g.car-sticker").attr("fill",color(f)),a.select("rect.speed-bar").attr("transform","translate("+-cW+","+(maxH-h(f))+")").attr("height",h(f)).attr("fill",color(f)),a.transition().ease("linear").duration(duration/subTime).attr("transform",function(){var b=Number(a.attr("nowX")),c=f+g/subTime;c>maxSpeed&&(c=maxSpeed,a.attr("acc",0)),a.attr("speed",c);var d=c/subTime;return b+d>width?(a.attr("nowX",b+d-width),"translate("+(b+d-width)+", 0)"):(a.attr("nowX",b+d),"translate("+(b+d)+", 0)")}).each("end",slide)}}var stop=!0,carNumber=22,maxSpeed=150,initSpeed=60,duration=1e3,subTime=100,accChange=100/subTime,selectedColor="orange",carArray=d3.range(1,carNumber+1),margin={left:10,right:0,top:10,bottom:0},width=1e3,height=200,x=d3.scale.linear().range([0,width]).domain([0,carNumber]),color=d3.scale.linear().range(["red","orange","yellowGreen"]).domain([0,.4*maxSpeed,.7*maxSpeed]),svg=d3.select("body").append("svg").attr("class","traffic-animation").attr("width","100%").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+(width+margin.left+margin.right)+" "+(height+margin.top+margin.bottom));svg.append("rect").attr("fill","skyBlue").attr("width","100%").attr("height","100%").attr("opacity",.2);var rH=25;svg.append("rect").attr("class","road").attr("transform","translate("+margin.left+","+(margin.top+height-rH)+")").attr("width",width).attr("height",rH).attr("fill","rgb(41, 48, 56)");var carWorkspace=svg.append("g").attr("class","car-workspace").attr("transform","translate("+margin.left+","+margin.top+")").attr("width",width).attr("height",height),carSelected="g#car-"+Math.round(carNumber/2),slow=-1,cW=15,cH=10,carSpace=carWorkspace.selectAll("g.car").data(carArray),newCarSpace=carSpace.enter().append("g").attr("class","car").attr("id",function(a){return"car-"+a}).attr("follow",function(a){return a!=carNumber?"car-"+(a+1):"car-1"}).attr("speed",initSpeed).attr("acc",0).attr("nowX",function(a){return x(a)}).attr("transform",function(a){return"translate("+x(a)+", 0)"});newCarSpace.append("rect").attr("class","selection").attr("transform","translate("+-cW+","+(height-rH+4)+")").attr("width",cW).attr("height",rH-8).attr("fill",function(a){return a==Math.round(carNumber/2)?selectedColor:"rgb(41, 48, 56)"}).on("click",function(a){carSelected="g#car-"+a,carWorkspace.selectAll("g").select("rect.selection").attr("fill","rgb(41, 48, 56)"),carWorkspace.select(carSelected).select("rect.selection").attr("fill",selectedColor)});var maxH=height-rH-2*cH,showSpeed=-1,h=d3.scale.linear().range([0,maxH]).domain([0,maxSpeed]);newCarSpace.append("rect").attr("class","speed-bar").attr("transform","translate("+-cW+","+(maxH-h(initSpeed))+")").attr("height",h(initSpeed)).attr("width",cW).attr("fill",color(initSpeed)).attr("opacity",function(){return 1==showSpeed?.9:0});var carSticker=newCarSpace.append("g").attr("class","car-sticker").attr("transform","translate(0,"+.82*height+")scale(-0.25, 0.4)").attr("fill",color(initSpeed));carSticker.append("path").attr("d","M 60.305562,10.535 48.492694,8.8979996 45.757389,-3.8766301e-7 l -20.857001,0 L 20.391999,9.8189996 1.4916526,11.456 0,24.445 l 4.3187416,0 c 0.29602,-4.882 2.799736,-8.694 5.8456504,-8.694 3.045305,0 5.549021,3.812 5.845041,8.694 l 26.91722,0 c 0.296021,-4.882 2.799736,-8.694 5.845042,-8.694 3.031933,0 5.527138,3.778 5.841394,8.628 l 5.318648,-1.264 c 0.0012,0.001 1.636928,-10.099 0.373825,-12.58 z m -26.407238,0.23 -10.496086,0 4.085937,-8.8980004 6.410149,0 z m 3.134848,0 0,-8.8990004 5.894696,0 2.735913,8.8980004 c 0,0 -5.471362,0.190393 -8.630609,0 -3.33e-4,-2e-5 0,0.001 0,0.001 z").on("click",function(a){carSelected="g#car-"+a,carWorkspace.selectAll("g").select("rect.selection").attr("fill","rgb(41, 48, 56)"),carWorkspace.select(carSelected).select("rect.selection").attr("fill",selectedColor)}),carSticker.append("path").attr("d","m 10.054902,17.506593 c -2.5569618,0 -4.6249999,2.068038 -4.6249999,4.625 0,2.556962 2.0680381,4.65625 4.6249999,4.65625 2.556962,0 4.625,-2.099288 4.625,-4.65625 0,-2.556962 -2.068038,-4.625 -4.625,-4.625 z m 0,2.90625 c 0.961699,0 1.75,0.757051 1.75,1.71875 0,0.961699 -0.788301,1.75 -1.75,1.75 -0.9616987,0 -1.7499999,-0.788301 -1.7499999,-1.75 0,-0.961699 0.7883012,-1.71875 1.7499999,-1.71875 z").on("click",function(a){carSelected="g#car-"+a,carWorkspace.selectAll("g").select("rect.selection").attr("fill","rgb(41, 48, 56)"),carWorkspace.select(carSelected).select("rect.selection").attr("fill",selectedColor)}),carSticker.append("path").attr("d","m 48.702755,17.506593 c -2.556962,0 -4.625,2.068038 -4.625,4.625 0,2.556962 2.068038,4.65625 4.625,4.65625 2.556962,0 4.625,-2.099288 4.625,-4.65625 0,-2.556962 -2.068038,-4.625 -4.625,-4.625 z m 0,2.90625 c 0.961699,0 1.75,0.757051 1.75,1.71875 0,0.961699 -0.788301,1.75 -1.75,1.75 -0.961699,0 -1.75,-0.788301 -1.75,-1.75 0,-0.961699 0.788301,-1.71875 1.75,-1.71875 z").on("click",function(a){carSelected="g#car-"+a,carWorkspace.selectAll("g").select("rect.selection").attr("fill","rgb(41, 48, 56)"),carWorkspace.select(carSelected).select("rect.selection").attr("fill",selectedColor)}),svg.append("rect").attr("fill","white").attr("width",margin.left).attr("height","100%"),svg.append("rect").attr("transform","translate("+(width+margin.left+margin.right-cW)+", 0)").attr("fill","white").attr("width",cW).attr("height","100%");
</script>
